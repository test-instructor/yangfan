services:
  server:
    image: "${REGISTRY:-yangfanz/}server:${IMAGE_TAG:-debug}"
    container_name: yangfan-server
    restart: always
    healthcheck:
      test:
        - CMD
        - python3
        - -c
        - "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8888/health', timeout=2).read()"
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
    volumes:
      - ./config/docker.config.yaml:/yangfan/docker.config.yaml:rw
    ports:
      - "8888:8888"
    networks:
      - yangfan-network

  run:
    image: "${REGISTRY:-yangfanz/}run:${IMAGE_TAG:-debug}"
    container_name: yangfan-run
    restart: always
    depends_on:
      server:
        condition: service_healthy
    environment:
      RUN_SERVICE_MODE: runner
      NODE_NAME: runner
    volumes:
      - ./config/docker.config.yaml:/yangfan/docker.config.yaml:ro
    networks:
      - yangfan-network

  run-all:
    image: "${REGISTRY:-yangfanz/}run:${IMAGE_TAG:-debug}"
    container_name: yangfan-run-all
    restart: always
    depends_on:
      server:
        condition: service_healthy
    environment:
      RUN_SERVICE_MODE: all
      NODE_NAME: runner-all
    volumes:
      - ./config/docker.config.yaml:/yangfan/docker.config.yaml:ro
    networks:
      - yangfan-network

  run-timer:
    image: "${REGISTRY:-yangfanz/}run:${IMAGE_TAG:-debug}"
    container_name: yangfan-run-timer
    restart: always
    depends_on:
      server:
        condition: service_healthy
    environment:
      RUN_SERVICE_MODE: timer
      NODE_NAME: runner-timer
    volumes:
      - ./config/docker.config.yaml:/yangfan/docker.config.yaml:ro
    networks:
      - yangfan-network

  data:
    image: "${REGISTRY:-yangfanz/}data:${IMAGE_TAG:-debug}"
    container_name: yangfan-data
    restart: always
    volumes:
      - ./config/docker.config.yaml:/yangfan/docker.config.yaml:ro
    ports:
      - "19000:9000"
    networks:
      - yangfan-network

  web:
    image: "${REGISTRY:-yangfanz/}web:${IMAGE_TAG:-debug}"
    container_name: yangfan-web
    restart: always
    depends_on:
      server:
        condition: service_healthy
    ports:
      - "8080:8080"
    environment:
      ENV_VITE_FS_APP_ID: ${ENV_VITE_FS_APP_ID:-}
      ENV_VITE_FS_LOGIN: ${ENV_VITE_FS_LOGIN:-http://localhost:8080/api/fsLogin/login}
    volumes:
      - ./config/my.conf:/etc/nginx/conf.d/my.conf:ro
    networks:
      - yangfan-network

networks:
  yangfan-network:
    name: yangfan-network
    driver: bridge
